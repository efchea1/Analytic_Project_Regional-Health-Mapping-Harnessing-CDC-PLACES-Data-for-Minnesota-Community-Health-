[{"name":"app.R","content":"# Load Packages ---------------------------------------------------------------\r\nlibrary(shiny)\r\n# library(readr) # Depended on curl not supportive in ShinyLive 06/11/2024\r\nlibrary(ggplot2)\r\n# library(kableExtra)\r\nlibrary(dplyr)\r\n# library(tidyverse)\r\nlibrary(shinydashboard)\r\n# library(shinyjs)\r\n\r\n# Load Data -------------------------------------------------------------------\r\n# Minnesota CDC Places Census Estimate data for 2020 to 2022\r\nCensusEstMN <- read.csv(\r\n  \"https://raw.githubusercontent.com/quincountychsmn/Public-Data-Sources/main/CDC%20Places/2020%20to%202022%20Pop.%20Estimates/cc-est2022-agesex.csv\",\r\n)\r\n\r\n# Minnesota Coronary Heart Disease (CHD) data 2018 to 2021\r\nCHD_files <- list(\r\n  'https://raw.githubusercontent.com/quincountychsmn/Public-Data-Sources/main/CDC%20Places/Places%20CDC%20Estimates/CHD/CHD2018.csv',\r\n  'https://raw.githubusercontent.com/quincountychsmn/Public-Data-Sources/main/CDC%20Places/Places%20CDC%20Estimates/CHD/CHD2019.csv',\r\n  'https://raw.githubusercontent.com/quincountychsmn/Public-Data-Sources/main/CDC%20Places/Places%20CDC%20Estimates/CHD/CHD2020.csv',\r\n  'https://raw.githubusercontent.com/quincountychsmn/Public-Data-Sources/main/CDC%20Places/Places%20CDC%20Estimates/CHD/CHD2021.csv'\r\n)\r\n\r\nCHD_data <- lapply(CHD_files, read.csv)\r\n\r\n# Data Wrangling --------------------------------------------------------------\r\n# Clean and merge CHD data\r\nCHD_data[[1]]$Latitude <- \"NA\"\r\ncolnames(CHD_data[[1]])[colnames(CHD_data[[1]]) == 'Latitude'] <- 'LocationID'\r\ncolnames(CHD_data[[1]])[colnames(CHD_data[[1]]) == 'Geolocatioin'] <- 'Geolocation'\r\nCHD_data <- lapply(CHD_data, function(df) {\r\n  df$LocationID <- as.character(df$LocationID)\r\n  return(df)\r\n})\r\nCHD_Final <- bind_rows(CHD_data)\r\n\r\n# Filter and select locations\r\nSelected_Locations <- CHD_Final |>\r\n  filter(LocationName %in% c(\"Kittson\", \"Marshall\", \"Roseau\", \"Red Lake\", \"Pennington\"),\r\n         Year == 2021, StateAbbr == \"MN\")\r\n\r\n# Clean census data\r\nCensusEstMN$CTYNAME <- gsub(\" County\", \"\", CensusEstMN$CTYNAME)\r\n\r\n# Population estimates for CHD in MN\r\nPopEst_CHDMN <- CensusEstMN |>\r\n  filter(YEAR == 3) |>\r\n  inner_join(Selected_Locations, by = c(\"CTYNAME\" = \"LocationName\")) |>\r\n  select(CTYNAME, Data_Value_Type, AGE18PLUS_TOT, Measure, Data_Value, High_Confidence_Limit, Low_Confidence_Limit)\r\n\r\n# Calculate crude and age-adjusted values\r\ncalc_aggregate_values <- function(df) {\r\n  df |>\r\n    mutate(Aggregate_Data_Value = Data_Value * AGE18PLUS_TOT / 100,\r\n           Aggregate_Low_Confidence_Limit = Low_Confidence_Limit * AGE18PLUS_TOT / 100,\r\n           Aggregate_High_Confidence_Limit = High_Confidence_Limit * AGE18PLUS_TOT / 100) |>\r\n    select(CTYNAME, Data_Value_Type, AGE18PLUS_TOT, Aggregate_High_Confidence_Limit,\r\n           Aggregate_Data_Value, Aggregate_Low_Confidence_Limit)\r\n}\r\n\r\nCHD_Crude21MN <- calc_aggregate_values(PopEst_CHDMN |> filter(Data_Value_Type == 'Crude prevalence'))\r\nCHD_Adj21MN <- calc_aggregate_values(PopEst_CHDMN |> filter(Data_Value_Type == 'Age-adjusted prevalence'))\r\nCHD_MN21 <- bind_rows(CHD_Adj21MN, CHD_Crude21MN)\r\n\r\n# User Interface --------------------------------------------------------------\r\nui <- dashboardPage(\r\n  dashboardHeader(title = \"CDC Places to MN Regions\", titleWidth = 400),\r\n  dashboardSidebar(\r\n    selectInput(\"parGlobal_inputOne\", \"Prevalence Estimate\",\r\n                choices = sort(unique(PopEst_CHDMN$Data_Value_Type)),\r\n                selected = unique(PopEst_CHDMN$Data_Value_Type)[1], width = 350),\r\n    selectInput(\"parGlobal_cascadeFromInputOneRestrictive\", \"Select MN County\", choices = NULL, width = 350)\r\n  ),\r\n  dashboardBody(\r\n    tabBox(\r\n      width = 12,\r\n      tabPanel(\"Data Tables\",\r\n               fluidRow(\r\n                 box(title = \"Selected Data Table\", status = \"primary\", solidHeader = TRUE, width = 12, tableOutput(\"selectedDataTable\")),\r\n                 box(title = \"CHD Data Table\", status = \"primary\", solidHeader = TRUE, width = 12, tableOutput(\"CHD_CHB21Table\"))\r\n               )\r\n      ),\r\n      tabPanel(\"CHD Prevalence Plot\",\r\n               fluidRow(\r\n                 box(title = \"CHD Prevalence Plot\", status = \"primary\", solidHeader = TRUE, width = 12, plotOutput(\"CHDPlot\"))\r\n               )\r\n      )\r\n    )\r\n  )\r\n)\r\n\r\n# Server ----------------------------------------------------------------------\r\nserver <- function(input, output, session) {\r\n  observeEvent(input$parGlobal_inputOne, {\r\n    updateSelectInput(session, \"parGlobal_cascadeFromInputOneRestrictive\",\r\n                      choices = unique(PopEst_CHDMN$CTYNAME[PopEst_CHDMN$Data_Value_Type == input$parGlobal_inputOne]),\r\n                      selected = unique(PopEst_CHDMN$CTYNAME[PopEst_CHDMN$Data_Value_Type == input$parGlobal_inputOne])[1])\r\n  })\r\n\r\n  selected_data <- reactive({\r\n    PopEst_CHDMN |>\r\n      filter(Data_Value_Type == input$parGlobal_inputOne, CTYNAME == input$parGlobal_cascadeFromInputOneRestrictive) |>\r\n      mutate(Aggregate_Data_Value = Data_Value * AGE18PLUS_TOT / 100)\r\n  })\r\n\r\n  output$selectedDataTable <- renderTable({ selected_data() })\r\n\r\n  CHD_CHB21 <- reactive({\r\n    PopEst_CHDMN |>\r\n      filter(Data_Value_Type == input$parGlobal_inputOne,\r\n             CTYNAME == input$parGlobal_cascadeFromInputOneRestrictive) |>\r\n      group_by(CTYNAME) |>\r\n      summarize(\r\n        Aggregate_Data_Value = sum(Data_Value * AGE18PLUS_TOT / 100) / sum(AGE18PLUS_TOT) * 100,\r\n        Aggregate_Low_Confidence_Limit = sum(Low_Confidence_Limit * AGE18PLUS_TOT / 100) / sum(AGE18PLUS_TOT) * 100,\r\n        Aggregate_High_Confidence_Limit = sum(High_Confidence_Limit * AGE18PLUS_TOT / 100) / sum(AGE18PLUS_TOT) * 100\r\n      ) |>\r\n      select(CTYNAME, Aggregate_High_Confidence_Limit, Aggregate_Data_Value, Aggregate_Low_Confidence_Limit)\r\n  })\r\n\r\n  output$CHD_CHB21Table <- renderTable({ CHD_CHB21() })\r\n\r\n  output$CHDPlot <- renderPlot({\r\n    ggplot(selected_data(), aes(x = CTYNAME, y = Aggregate_Data_Value, fill = Data_Value_Type)) +\r\n      geom_bar(stat = \"identity\", position = position_dodge()) +\r\n      labs(title = \"CHD Prevalence in Selected Counties\", x = \"County\", y = \"Prevalence (%)\") +\r\n      theme_minimal()\r\n  })\r\n}\r\n\r\n# Run the Application ---------------------------------------------------------\r\nshinyApp(ui = ui, server = server)","type":"text"}]
